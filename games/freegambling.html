<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Play a fun slot machine and dice game with realistic animations and fair odds">
    <meta name="keywords" content="slot machine, dice game, gambling game, free game">
    <title>Slot Machine</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé∞</text></svg>">
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #1a1a1a 100%);
            color: white;
            padding: 20px;
        }

        h1 {
            margin: 20px 0;
            font-size: 2.5em;
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .slot-machine, .dice-game {
            background-color: rgba(52, 73, 94, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin: 10px;
            width: 100%;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }

        .slots {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .slot {
            width: 90px;
            height: 90px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5em;
            border-radius: 10px;
            color: #2c3e50;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .slot:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .bet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .bet-input {
            width: 120px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #3498db;
            padding: 5px 10px;
            font-size: 16px;
            text-align: center;
            background-color: rgba(255,255,255,0.9);
            transition: border-color 0.3s;
        }

        .bet-input:focus {
            outline: none;
            border-color: #f1c40f;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            transform: none;
            box-shadow: none;
        }

        .stats {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .stats p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .high-score {
            color: #f1c40f;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .slots {
                gap: 10px;
            }
            
            .slot {
                width: 70px;
                height: 70px;
                font-size: 2em;
            }
            
            .bet-controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }

        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-2000px); }
        }

        .spinning {
            animation: spin 2s cubic-bezier(0.1, 0.7, 0.1, 1);
            overflow: hidden;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup {
            background-color: #34495e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
        }

        .popup input {
            width: 150px;
            padding: 8px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        .popup button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #e74c3c;
            color: white;
        }

        .popup button:hover {
            background-color: #c0392b;
        }

        .bet-input::placeholder {
            color: #95a5a6;
        }

        .dice-game {
            display: none;
            background-color: #34495e;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
        }

        .dice-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }

        .dice {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #2c3e50;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .dice.rolling {
            animation: roll 1s cubic-bezier(0.1, 0.7, 0.1, 1);
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .how-to-play-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .how-to-play-btn:hover {
            background-color: #2980b9;
        }

        .how-to-play-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #34495e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            color: white;
        }

        .how-to-play-popup h3 {
            margin-top: 0;
            color: #f1c40f;
        }

        .how-to-play-popup ul {
            padding-left: 20px;
        }

        .how-to-play-popup li {
            margin-bottom: 10px;
        }

        .close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* Dutch Flag Game Styles */
        .dutch-flag-game {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom,
                #AE1C28 0%,
                #AE1C28 33.33%,
                #FFFFFF 33.33%,
                #FFFFFF 66.66%,
                #21468B 66.66%,
                #21468B 100%
            );
            z-index: 9999;
        }

        .flag-game-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            min-width: 300px;
        }

        .flag-game-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 2em;
            margin-bottom: 20px;
        }

        .flag-bet-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .flag-bet-input {
            width: 120px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #fff;
            padding: 5px 10px;
            font-size: 16px;
            text-align: center;
            background-color: rgba(255,255,255,0.9);
        }

        .flag-color-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .flag-color-btn {
            padding: 15px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .flag-color-btn.red {
            background-color: #AE1C28;
        }

        .flag-color-btn.white {
            background-color: #FFFFFF;
            color: #000;
        }

        .flag-color-btn.blue {
            background-color: #21468B;
        }

        .flag-color-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .flag-color-btn:disabled {
            opacity: 0.5;
            transform: none;
            box-shadow: none;
        }

        .flag-sequence {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            min-height: 60px;
        }

        .flag-color-box {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .flag-stats {
            background-color: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .flag-stats p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .flag-high-score {
            color: #f1c40f;
            font-weight: bold;
        }

        /* Message Display Styles */
        .message-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.2em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .message-display.show {
            opacity: 1;
        }

        .message-display.error {
            background-color: rgba(231, 76, 60, 0.9);
        }

        .message-display.success {
            background-color: rgba(46, 204, 113, 0.9);
        }

        .message-display.info {
            background-color: rgba(52, 152, 219, 0.9);
        }

        .message-display.neutral {
            background-color: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="message-display" id="slotMessage"></div>
        <h1>üé∞ Slot Machine üé∞</h1>
        
        <div class="slot-machine" id="slotGame">
            <button class="how-to-play-btn" onclick="showHowToPlay('slot')">?</button>
            <div class="slots">
                <div class="slot" id="slot1">?</div>
                <div class="slot" id="slot2">?</div>
                <div class="slot" id="slot3">?</div>
            </div>
            <div class="bet-controls">
                <input type="number" id="betAmount" class="bet-input" placeholder="Bet Amount" min="1" value="10">
        <button onclick="spin()">Spin!</button>
            </div>
        <div class="stats">
            <p>Balance: $<span id="balance">100</span></p>
            <p>Last Win: $<span id="lastWin">0</span></p>
                <p class="high-score">Highest Balance: $<span id="highScore">100</span></p>
            </div>
        </div>

        <div class="dice-game" id="diceGame">
            <div class="message-display" id="diceMessage"></div>
            <button class="how-to-play-btn" onclick="showHowToPlay('dice')">?</button>
            <h2>Dice Game</h2>
            <div class="dice-container">
                <div class="dice" id="dice1">?</div>
                <div class="dice" id="dice2">?</div>
            </div>
            <div class="bet-controls">
                <input type="number" id="diceBetAmount" class="bet-input" placeholder="Bet Amount" min="1" value="10">
                <button onclick="rollDice()">Roll Dice!</button>
            </div>
            <div class="stats">
                <p>Balance: $<span id="diceBalance">100</span></p>
                <p>Last Win: $<span id="diceLastWin">0</span></p>
                <p class="high-score">Highest Balance: $<span id="diceHighScore">100</span></p>
            </div>
        </div>
    </div>

    <div class="dutch-flag-game" id="dutchFlagGame">
        <div class="message-display" id="flagMessage"></div>
        <div class="flag-game-container">
            <h1 class="flag-game-title">üá≥üá± Flag Color Game üá≥üá±</h1>
            <div class="flag-sequence" id="flagSequence"></div>
            <div class="flag-bet-controls">
                <input type="number" id="flagBetAmount" class="flag-bet-input" placeholder="Bet Amount" min="1" value="10">
            </div>
            <div class="flag-color-buttons">
                <button class="flag-color-btn red" onclick="betOnColor('red')">Red</button>
                <button class="flag-color-btn white" onclick="betOnColor('white')">White</button>
                <button class="flag-color-btn blue" onclick="betOnColor('blue')">Blue</button>
            </div>
            <div class="flag-stats">
                <p>Balance: $<span id="flagBalance">100</span></p>
                <p>Last Win: $<span id="flagLastWin">0</span></p>
                <p class="flag-high-score">Highest Balance: $<span id="flagHighScore">100</span></p>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="moneyPopup">
        <div class="popup">
            <h3>Add Money</h3>
            <input type="number" id="moneyAmount" placeholder="Enter amount" min="1" autofocus>
            <div>
                <button onclick="addCustomMoney()">Add</button>
                <button onclick="closeMoneyPopup()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="how-to-play-popup" id="howToPlayPopup">
        <button class="close-popup" onclick="closeHowToPlay()">√ó</button>
        <div id="slotInstructions">
            <h3>How to Play Slot Machine</h3>
            <ul>
                <li>Set your bet amount using the input field</li>
                <li>Click the "Spin!" button to start the game</li>
                <li>Winning combinations:
                    <ul>
                        <li>Three üíé: 10x your bet</li>
                        <li>Three 7Ô∏è‚É£: 5x your bet</li>
                        <li>Three matching symbols: 2.5x your bet</li>
                        <li>Two matching symbols: 0.5x your bet</li>
                    </ul>
                </li>
                <li>Higher bets get bonus multipliers:
                    <ul>
                        <li>$1000+ bets: 50% bonus</li>
                        <li>$500+ bets: 30% bonus</li>
                        <li>$100+ bets: 20% bonus</li>
                        <li>$50+ bets: 10% bonus</li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="diceInstructions" style="display: none;">
            <h3>How to Play Dice Game</h3>
            <ul>
                <li>Set your bet amount using the input field</li>
                <li>Click the "Roll Dice!" button to start the game</li>
                <li>Winning combinations:
                    <ul>
                        <li>Double sixes: 5x your bet</li>
                        <li>Any other pair: 2x your bet</li>
                        <li>Sum of 7: 3x your bet</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // Enhanced security measures
        const SECURITY = (() => {
            let lastOperationTime = Date.now();
            const MIN_OPERATION_INTERVAL = 1000; // 1 second between operations
            let operationCount = 0;
            const MAX_OPERATIONS_PER_MINUTE = 60;
            let lastMinuteStart = Date.now();

            return {
                validateOperation: () => {
                    const now = Date.now();
                    
                    // Reset operation count every minute
                    if (now - lastMinuteStart > 60000) {
                        operationCount = 0;
                        lastMinuteStart = now;
                    }
                    
                    // Check rate limiting
                    if (operationCount >= MAX_OPERATIONS_PER_MINUTE) {
                        console.error('Too many operations. Please wait.');
                        return false;
                    }
                    
                    // Check minimum interval between operations
                    if (now - lastOperationTime < MIN_OPERATION_INTERVAL) {
                        console.error('Operations too frequent. Please wait.');
                        return false;
                    }
                    
                    operationCount++;
                    lastOperationTime = now;
                    return true;
                },
                
                validateAmount: (amount) => {
                    if (typeof amount !== 'number' || isNaN(amount) || !isFinite(amount)) {
                        console.error('Invalid amount');
                        return false;
                    }
                    if (amount < 0 || amount > 1000000) { // Reasonable limit
                        console.error('Amount out of range');
                        return false;
                    }
                    return true;
                }
            };
        })();

        // Completely private game state with no global access
        const GAME_STATE = (() => {
        let balance = 100;
            let highScore = 100;
            
            return {
                getBalance: () => balance,
                getHighScore: () => highScore,
                updateBalance: (amount) => {
                    const newBalance = balance + amount;
                    if (newBalance >= 0 && newBalance <= 1000000) {
                        balance = newBalance;
                        if (balance > highScore) {
                            highScore = balance;
                        }
                    }
                    return balance;
                },
                reset: () => {
                    balance = 100;
                    highScore = Math.max(highScore, 100);
                }
            };
        })();

        // Make game state completely private
        Object.freeze(GAME_STATE);
        Object.defineProperty(window, 'GAME_STATE', {
            value: GAME_STATE,
            writable: false,
            configurable: false,
            enumerable: false
        });

        // Override console methods to prevent tampering
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        console.log = function() {
            if (arguments[0] && typeof arguments[0] === 'string' && 
                arguments[0].includes('GAME_STATE')) {
                return;
            }
            originalConsole.log.apply(console, arguments);
        };

        // Update all game state references to use the new secure state
        const gameState = GAME_STATE;

        // Update dice game state to use the secure state
        const diceGameState = (() => {
            return {
                getBalance: () => GAME_STATE.getBalance(),
                getHighScore: () => GAME_STATE.getHighScore(),
                updateBalance: (amount) => GAME_STATE.updateBalance(amount),
                reset: () => GAME_STATE.reset()
            };
        })();

        // Prevent prototype pollution
        Object.freeze(Object.prototype);
        Object.freeze(Function.prototype);
        Object.freeze(Array.prototype);

        // Add money popup security
        function addCustomMoney() {
            if (!SECURITY.validateOperation()) return;
            
            const amount = parseInt(moneyInput.value);
            if (!SECURITY.validateAmount(amount)) {
                messageSystem.showError('Invalid amount');
                return;
            }
            
            GAME_STATE.updateBalance(amount);
            updateDisplay();
            closeMoneyPopup();
            messageSystem.showSuccess(`Added $${amount} to your balance!`);
        }

        // Enhanced bet validation
        function validateBet() {
            if (!SECURITY.validateOperation()) return false;
            
            const betAmount = parseInt(betInput.value);
            if (!SECURITY.validateAmount(betAmount)) {
                messageSystem.showError('Invalid bet amount');
                betInput.value = '10';
                return false;
            }
            
            const currentBalance = GAME_STATE.getBalance();
            if (betAmount > currentBalance) {
                messageSystem.showError('Not enough balance for this bet!');
                betInput.value = currentBalance.toString();
                return false;
            }
            return true;
        }

        // Update all display functions to use secure state
        function updateDisplay() {
            const currentBalance = GAME_STATE.getBalance();
            const currentHighScore = GAME_STATE.getHighScore();
            
            balanceElement.textContent = currentBalance;
            highScoreElement.textContent = currentHighScore;
            
            // Update bet input max value
            betInput.max = currentBalance;
        }

        function updateDiceDisplay() {
            const currentBalance = GAME_STATE.getBalance();
            const currentHighScore = GAME_STATE.getHighScore();
            
            document.getElementById('diceBalance').textContent = currentBalance;
            document.getElementById('diceHighScore').textContent = currentHighScore;
            
            // Update bet input max value
            document.getElementById('diceBetAmount').max = currentBalance;
        }

        const symbols = ['üçí', 'üçä', 'üçá', '7Ô∏è‚É£', 'üíé'];
        const balanceElement = document.getElementById('balance');
        const lastWinElement = document.getElementById('lastWin');
        const highScoreElement = document.getElementById('highScore');
        const spinButton = document.querySelector('button');
        const betInput = document.getElementById('betAmount');
        const moneyPopup = document.getElementById('moneyPopup');
        const moneyInput = document.getElementById('moneyAmount');
        const SPIN_DURATION = 2000;
        const SPIN_INTERVAL = 50;
        const SPINS_PER_SLOT = 40;
        const SLOT_DELAY = 300;
        
        // Win rate settings (0.0 to 1.0, where 1.0 is 100% win rate)
        const WIN_RATE = 0.3; // 30% chance of winning
        const SYMBOL_WEIGHTS = {
            'üçí': 1,
            'üçä': 1,
            'üçá': 1,
            '7Ô∏è‚É£': 0.1,  // Uncommon
            'üíé': 0.2 // Rare
        };

        // Secure random number generator
        const RNG = (() => {
            let seed = Math.floor(Math.random() * 1000000);
            
            return {
                getRandom: () => {
                    seed = (seed * 16807) % 2147483647;
                    return (seed - 1) / 2147483646;
                },
                getRandomInt: (min, max) => {
                    return Math.floor(RNG.getRandom() * (max - min + 1)) + min;
                }
            };
        })();

        function resetGame() {
            gameState.reset();
            lastWinElement.textContent = '0';
            betInput.value = '10';
            updateDisplay();
        }

        // Keyboard shortcut for adding money
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                e.preventDefault();
                openMoneyPopup();
            }
        });

        // Money popup functions
        function openMoneyPopup() {
            moneyPopup.style.display = 'flex';
            moneyInput.value = '';
            moneyInput.focus();
        }

        function closeMoneyPopup() {
            moneyPopup.style.display = 'none';
        }

        // Close popup when clicking outside
        moneyPopup.addEventListener('click', (e) => {
            if (e.target === moneyPopup) {
                closeMoneyPopup();
            }
        });

        // Handle Enter key in the input
        moneyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addCustomMoney();
            } else if (e.key === 'Escape') {
                closeMoneyPopup();
            }
        });

        // Utility functions
        function getRandomSymbol() {
            // For normal spins, use normal weights
            const totalWeight = Object.values(SYMBOL_WEIGHTS).reduce((a, b) => a + b, 0);
            let random = RNG.getRandom() * totalWeight;
            
            for (const [symbol, weight] of Object.entries(SYMBOL_WEIGHTS)) {
                if (random < weight) {
                    return symbol;
                }
                random -= weight;
            }
            
            // Fallback to random symbol if something goes wrong
            return symbols[RNG.getRandomInt(0, symbols.length - 1)];
        }

        function updateSlot(slotId, symbol) {
            document.getElementById(slotId).textContent = symbol;
        }

        // Main game function
        async function spin() {
            if (!validateBet()) return;

            const betAmount = parseInt(betInput.value);
            const spinButton = document.querySelector('#slotGame button:not(.how-to-play-btn)');

            // Disable spin button
            spinButton.disabled = true;
            spinButton.style.opacity = '0.7';

            // Deduct bet amount
            GAME_STATE.updateBalance(-betAmount);
            updateDisplay();

            // Generate random symbols with win rate consideration
            const spinResults = [
                getRandomSymbol(),
                getRandomSymbol(),
                getRandomSymbol()
            ];

            // If this is a winning spin, ensure at least two symbols match
            if (RNG.getRandom() < WIN_RATE) {
                const winningSymbol = spinResults[RNG.getRandomInt(0, 2)];
                spinResults[1] = winningSymbol;
                if (RNG.getRandom() < 0.5) { // 50% chance for three of a kind
                    spinResults[0] = winningSymbol;
                    spinResults[2] = winningSymbol;
                } else {
                    spinResults[RNG.getRandom() < 0.5 ? 0 : 2] = winningSymbol;
                }
            }

            // Animate each slot with increasing delay
            const animations = [
                animateSpin('slot1', spinResults[0]),
                new Promise(resolve => setTimeout(() => animateSpin('slot2', spinResults[1]).then(resolve), SLOT_DELAY)),
                new Promise(resolve => setTimeout(() => animateSpin('slot3', spinResults[2]).then(resolve), SLOT_DELAY * 2))
            ];

            // Wait for all animations to complete
            await Promise.all(animations);

            // Small delay after last slot stops
            await new Promise(resolve => setTimeout(resolve, 500));

            // Calculate and show results
            const winAmount = calculateWin(spinResults) * betAmount;
            lastWinElement.textContent = winAmount;

            // Update balance with winnings
            if (winAmount > 0) {
                GAME_STATE.updateBalance(winAmount);
                messageSystem.showSuccess(`Congratulations! You won $${winAmount}!`, 'slot');
            } else {
                messageSystem.showNeutral('Better luck next time!', 'slot');
            }
            
            updateDisplay();

            // Check for game over
            if (GAME_STATE.getBalance() < 1) {
                messageSystem.showError(`Game Over! Your highest balance was $${GAME_STATE.getHighScore()}`, 'slot');
                resetGame();
            }

            // Re-enable spin button
            spinButton.disabled = false;
            spinButton.style.opacity = '1';
        }

        // Update win calculation to be proportional to bet
        function calculateWin(symbols) {
            const betAmount = parseInt(betInput.value);
            let baseMultiplier = 1;

            // Determine base multiplier based on bet amount
            if (betAmount >= 1000) {
                baseMultiplier = 1.5;  // 50% bonus for bets >= $1000
            } else if (betAmount >= 500) {
                baseMultiplier = 1.3;  // 30% bonus for bets >= $500
            } else if (betAmount >= 100) {
                baseMultiplier = 1.2;  // 20% bonus for bets >= $100
            } else if (betAmount >= 50) {
                baseMultiplier = 1.1;  // 10% bonus for bets >= $50
            }

            if (symbols[0] === symbols[1] && symbols[1] === symbols[2]) {
                // All three match
                if (symbols[0] === 'üíé') return Math.floor(10 * baseMultiplier); // 10x bet (up to 15x for high bets)
                if (symbols[0] === '7Ô∏è‚É£') return Math.floor(5 * baseMultiplier);  // 5x bet (up to 7.5x for high bets)
                return Math.floor(2.5 * baseMultiplier);  // 2.5x bet (up to 3.75x for high bets)
            } else if (symbols[0] === symbols[1] || symbols[1] === symbols[2]) {
                // Two match
                return Math.floor(0.5 * baseMultiplier);  // 0.5x bet (up to 0.75x for high bets)
            }
            return 0;
        }

        // Add event listeners for bet input
        betInput.addEventListener('input', () => {
            let value = betInput.value;
            if (value < 1) value = 1;
            if (value > gameState.getBalance()) value = gameState.getBalance();
            betInput.value = value;

            // Update bet amount display with multiplier info
            updateBetInfo();
        });

        function updateBetInfo() {
            const betAmount = parseInt(betInput.value);
            let multiplier = 1;
            let bonus = '';

            if (betAmount >= 1000) {
                multiplier = 1.5;
                bonus = '50% Bonus';
            } else if (betAmount >= 500) {
                multiplier = 1.3;
                bonus = '30% Bonus';
            } else if (betAmount >= 100) {
                multiplier = 1.2;
                bonus = '20% Bonus';
            } else if (betAmount >= 50) {
                multiplier = 1.1;
                bonus = '10% Bonus';
            }

            // Update the bet input placeholder to show the current multiplier
            betInput.placeholder = `Bet Amount ${bonus ? `(${bonus})` : ''}`;
        }

        // Call updateBetInfo initially
        updateBetInfo();

        // Animation functions
        function animateSpin(slotId, finalSymbol) {
            return new Promise((resolve) => {
            const slot = document.getElementById(slotId);
            let spins = 0;
            
                // Reset position
                slot.style.transform = 'translateY(0)';
            slot.classList.add('spinning');
            
            const interval = setInterval(() => {
                    slot.textContent = getRandomSymbol();
                spins++;
                
                    if (spins > SPINS_PER_SLOT) {
                    clearInterval(interval);
                        setTimeout(() => {
                    slot.classList.remove('spinning');
                    slot.textContent = finalSymbol;
                            slot.style.transform = 'translateY(0)';
                            resolve();
                        }, 100);
                    }
                }, SPIN_INTERVAL);
            });
        }

        function showWinMessage(amount) {
            if (amount > 0) {
                alert(`Congratulations! You won $${amount}!`);
            }
        }

        // Secret code handling
        let codeSequence = '';
        const SECRET_CODE_DICE = 'saya';
        const SECRET_CODE_FLAG = '.nl';
        let isDiceGame = false;
        let isDutchFlagGame = false;
        let lastKeyTime = Date.now();
        const MAX_TIME_BETWEEN_KEYS = 2000; // 2 second max between keys

        document.addEventListener('keydown', (e) => {
            if (!isDiceGame && !isDutchFlagGame) {
                const currentTime = Date.now();
                
                // Reset sequence if too much time has passed between keys
                if (currentTime - lastKeyTime > MAX_TIME_BETWEEN_KEYS) {
                    codeSequence = '';
                }
                
                // Add the key to the sequence
                codeSequence += e.key.toLowerCase();
                lastKeyTime = currentTime;
                
                // Check for Dutch flag code
                if (codeSequence === SECRET_CODE_FLAG) {
                    switchToDutchFlagGame();
                    codeSequence = '';
                }
                // Check if sequence matches the dice game secret code
                else if (codeSequence === SECRET_CODE_DICE) {
                    switchToDiceGame();
                    codeSequence = '';
                } else if (!SECRET_CODE_DICE.includes(codeSequence) && !SECRET_CODE_FLAG.includes(codeSequence)) {
                    // Reset if current sequence doesn't match any secret code
                    codeSequence = '';
                }
            }
        });

        // Message Display System
        const messageSystem = (() => {
            const messageElements = {
                slot: document.getElementById('slotMessage'),
                dice: document.getElementById('diceMessage'),
                flag: document.getElementById('flagMessage')
            };
            const messageTimeouts = {};

            const showMessage = (message, type = 'info', duration = 3000, game = 'slot') => {
                const messageElement = messageElements[game];
                if (!messageElement) return;

                if (messageTimeouts[game]) {
                    clearTimeout(messageTimeouts[game]);
                }

                messageElement.textContent = message;
                messageElement.className = 'message-display';
                messageElement.classList.add(type);
                
                // Force reflow
                messageElement.offsetHeight;
                
                messageElement.classList.add('show');

                messageTimeouts[game] = setTimeout(() => {
                    messageElement.classList.remove('show');
                }, duration);
            };

            return {
                showMessage: (message, type = 'info', duration = 3000, game = 'slot') => 
                    showMessage(message, type, duration, game),
                showError: (message, game = 'slot') => showMessage(message, 'error', 3000, game),
                showSuccess: (message, game = 'slot') => showMessage(message, 'success', 3000, game),
                showInfo: (message, game = 'slot') => showMessage(message, 'info', 3000, game),
                showNeutral: (message, game = 'slot') => showMessage(message, 'neutral', 3000, game)
            };
        })();

        // Flag Game State
        const FLAG_GAME_STATE = (() => {
            let balance = 100;
            let highScore = 100;
            let sequence = [];
            const MAX_SEQUENCE_LENGTH = 5;
            let lastOperationTime = Date.now();
            let operationCount = 0;
            let lastMinuteStart = Date.now();
            const MAX_OPERATIONS_PER_MINUTE = 60;
            const MIN_OPERATION_INTERVAL = 1000; // 1 second between operations
            
            // Secure random number generator for flag game
            const FLAG_RNG = (() => {
                let seed = Math.floor(Math.random() * 1000000);
                const multiplier = 16807;
                const modulus = 2147483647;
                
                return {
                    getRandom: () => {
                        seed = (seed * multiplier) % modulus;
                        return (seed - 1) / (modulus - 1);
                    },
                    getRandomInt: (min, max) => {
                        return Math.floor(FLAG_RNG.getRandom() * (max - min + 1)) + min;
                    }
                };
            })();
            
            const state = {
                getBalance: () => balance,
                getHighScore: () => highScore,
                updateBalance: (amount) => {
                    if (!SECURITY.validateAmount(amount)) return balance;
                    
                    const newBalance = balance + amount;
                    if (newBalance >= 0 && newBalance <= 1000000) {
                        balance = newBalance;
                        if (balance > highScore) {
                            highScore = balance;
                        }
                    }
                    return balance;
                },
                reset: () => {
                    balance = 100;
                    highScore = Math.max(highScore, 100);
                    sequence = [];
                },
                getSequence: () => [...sequence], // Return copy to prevent direct modification
                addToSequence: (color) => {
                    if (!['red', 'white', 'blue'].includes(color)) return;
                    
                    sequence.push(color);
                    if (sequence.length > MAX_SEQUENCE_LENGTH) {
                        sequence.shift();
                    }
                },
                clearSequence: () => {
                    sequence = [];
                },
                validateOperation: () => {
                    const now = Date.now();
                    
                    // Reset operation count every minute
                    if (now - lastMinuteStart > 60000) {
                        operationCount = 0;
                        lastMinuteStart = now;
                    }
                    
                    // Check rate limiting
                    if (operationCount >= MAX_OPERATIONS_PER_MINUTE) {
                        console.error('Too many operations. Please wait.');
                        return false;
                    }
                    
                    // Check minimum interval between operations
                    if (now - lastOperationTime < MIN_OPERATION_INTERVAL) {
                        console.error('Operations too frequent. Please wait.');
                        return false;
                    }
                    
                    operationCount++;
                    lastOperationTime = now;
                    return true;
                },
                getRandomColor: () => {
                    const colors = ['red', 'white', 'blue'];
                    return colors[FLAG_RNG.getRandomInt(0, 2)];
                }
            };

            // Freeze the state object to prevent modifications
            return Object.freeze(state);
        })();

        // Flag Game Functions
        const flagGame = (() => {
            const updateDisplay = () => {
                const currentBalance = FLAG_GAME_STATE.getBalance();
                const currentHighScore = FLAG_GAME_STATE.getHighScore();
                
                document.getElementById('flagBalance').textContent = currentBalance;
                document.getElementById('flagHighScore').textContent = currentHighScore;
                document.getElementById('flagBetAmount').max = currentBalance;
            };

            const updateSequence = () => {
                const sequenceContainer = document.getElementById('flagSequence');
                sequenceContainer.innerHTML = '';
                
                FLAG_GAME_STATE.getSequence().forEach(color => {
                    const colorBox = document.createElement('div');
                    colorBox.className = 'flag-color-box';
                    colorBox.style.backgroundColor = color === 'red' ? '#AE1C28' : 
                                                   color === 'white' ? '#FFFFFF' : '#21468B';
                    sequenceContainer.appendChild(colorBox);
                });
            };

            const betOnColor = async (betColor) => {
                if (!FLAG_GAME_STATE.validateOperation()) {
                    messageSystem.showError('Please wait before making another bet.');
                    return;
                }
                
                const betInput = document.getElementById('flagBetAmount');
                const betAmount = parseInt(betInput.value);
                
                if (!SECURITY.validateAmount(betAmount)) {
                    messageSystem.showError('Invalid bet amount');
                    betInput.value = '10';
                    return;
                }
                
                const currentBalance = FLAG_GAME_STATE.getBalance();
                if (betAmount > currentBalance) {
                    messageSystem.showError('Not enough balance for this bet!');
                    betInput.value = currentBalance.toString();
                    return;
                }

                // Disable buttons during animation
                const buttons = document.querySelectorAll('.flag-color-btn');
                buttons.forEach(btn => btn.disabled = true);

                // Deduct bet
                FLAG_GAME_STATE.updateBalance(-betAmount);
                updateDisplay();

                // Generate new color using secure RNG
                const newColor = FLAG_GAME_STATE.getRandomColor();
                FLAG_GAME_STATE.addToSequence(newColor);
                updateSequence();

                // Calculate winnings
                let winAmount = 0;
                if (newColor === betColor) {
                    winAmount = Math.floor(betAmount * 2); // 2x payout for correct guess
                }

                // Update display
                document.getElementById('flagLastWin').textContent = winAmount;
                
                // Update balance with winnings
                if (winAmount > 0) {
                    FLAG_GAME_STATE.updateBalance(winAmount);
                    messageSystem.showSuccess(`Congratulations! You won $${winAmount}!`, 'flag');
                } else {
                    messageSystem.showNeutral('Better luck next time!', 'flag');
                }
                
                updateDisplay();

                // Check for game over
                if (FLAG_GAME_STATE.getBalance() < 1) {
                    messageSystem.showError(`Game Over! Your highest balance was $${FLAG_GAME_STATE.getHighScore()}`);
                    FLAG_GAME_STATE.reset();
                    updateDisplay();
                }

                // Re-enable buttons
                buttons.forEach(btn => btn.disabled = false);
            };

            const initialize = () => {
                FLAG_GAME_STATE.reset();
                updateDisplay();
                FLAG_GAME_STATE.clearSequence();
                updateSequence();
                messageSystem.showMessage('Welcome to the Flag Game!');
            };

            return {
                betOnColor,
                initialize
            };
        })();

        function switchToDutchFlagGame() {
            isDutchFlagGame = true;
            document.getElementById('slotGame').style.display = 'none';
            document.getElementById('diceGame').style.display = 'none';
            document.getElementById('dutchFlagGame').style.display = 'block';
            document.title = 'Flag Game';
            messageSystem.showInfo('Secret code activated! Welcome to the Flag Game!', 'flag');
            
            flagGame.initialize();
        }

        function switchToDiceGame() {
            isDiceGame = true;
            document.getElementById('slotGame').style.display = 'none';
            document.getElementById('diceGame').style.display = 'block';
            document.title = 'Dice Game';
            messageSystem.showInfo('Secret code activated! Welcome to the Dice Game!', 'dice');
        }

        async function rollDice() {
            const betAmount = parseInt(document.getElementById('diceBetAmount').value);
            const currentBalance = GAME_STATE.getBalance();
            const rollButton = document.querySelector('#diceGame button:not(.how-to-play-btn)');

            if (!betAmount || betAmount < 1) {
                messageSystem.showError('Please enter a valid bet amount (minimum $1)', 'dice');
                return;
            }
            if (betAmount > currentBalance) {
                messageSystem.showError('Not enough balance for this bet!', 'dice');
                return;
            }

            // Disable button during roll
            rollButton.disabled = true;
            rollButton.style.opacity = '0.7';

            // Deduct bet
            GAME_STATE.updateBalance(-betAmount);
            updateDiceDisplay();

            // Animate dice
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            dice1.classList.add('rolling');
            dice2.classList.add('rolling');

            // Roll animation
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Get results using secure RNG
            const result1 = RNG.getRandomInt(1, 6);
            const result2 = RNG.getRandomInt(1, 6);

            // Show results
            dice1.textContent = result1;
            dice2.textContent = result2;
            dice1.classList.remove('rolling');
            dice2.classList.remove('rolling');

            // Calculate winnings
            let winAmount = 0;
            if (result1 === result2) {
                if (result1 === 6) {
                    winAmount = Math.floor(betAmount * 5); // Double sixes = 5x
                } else {
                    winAmount = Math.floor(betAmount * 2); // Any pair = 2x
                }
            } else if (result1 + result2 === 7) {
                winAmount = Math.floor(betAmount * 3); // Sum of 7 = 3x
            }

            // Update display
            document.getElementById('diceLastWin').textContent = winAmount;
            
            // Update balance with winnings
            if (winAmount > 0) {
                GAME_STATE.updateBalance(winAmount);
                messageSystem.showSuccess(`Congratulations! You won $${winAmount}!`, 'dice');
            } else {
                messageSystem.showNeutral('Better luck next time!', 'dice');
            }
            
            updateDiceDisplay();

            // Check for game over
            if (GAME_STATE.getBalance() < 1) {
                messageSystem.showError(`Game Over! Your highest balance was $${GAME_STATE.getHighScore()}`, 'dice');
                GAME_STATE.reset();
                updateDiceDisplay();
            }

            // Re-enable button
            rollButton.disabled = false;
            rollButton.style.opacity = '1';
        }

        // Initialize displays
        updateDisplay();
        updateDiceDisplay();

        // Update the onclick handlers to use the new flagGame object
        document.addEventListener('DOMContentLoaded', () => {
            const redButton = document.querySelector('.flag-color-btn.red');
            const whiteButton = document.querySelector('.flag-color-btn.white');
            const blueButton = document.querySelector('.flag-color-btn.blue');
            
            if (redButton) redButton.onclick = () => flagGame.betOnColor('red');
            if (whiteButton) whiteButton.onclick = () => flagGame.betOnColor('white');
            if (blueButton) blueButton.onclick = () => flagGame.betOnColor('blue');
        });

        // How to Play functions
        function showHowToPlay(game) {
            const popup = document.getElementById('howToPlayPopup');
            const slotInstructions = document.getElementById('slotInstructions');
            const diceInstructions = document.getElementById('diceInstructions');
            
            if (game === 'slot') {
                slotInstructions.style.display = 'block';
                diceInstructions.style.display = 'none';
            } else {
                slotInstructions.style.display = 'none';
                diceInstructions.style.display = 'block';
            }
            
            popup.style.display = 'block';
        }

        function closeHowToPlay() {
            document.getElementById('howToPlayPopup').style.display = 'none';
        }

        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('howToPlayPopup');
            if (e.target === popup) {
                closeHowToPlay();
            }
        });

        // Close popup with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHowToPlay();
            }
        });
    </script>
</body>
</html>